


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>TorchServe Metrics &mdash; PyTorch/Serve master documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="_static/katex-math.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Model Zoo" href="model_zoo.html" />
    <link rel="prev" title="Logging in Torchserve" href="logging.html" />
  <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','');</script>
    <!-- End Google Tag Manager -->
  

  
  <script src="_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>

          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-orange-arrow">
                Docs
              </a>
              <div class="resources-dropdown-menu">
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/docs/stable/index.html">
                  <span class="dropdown-title">PyTorch</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/audio/stable/index.html">
                  <span class="dropdown-title">torchaudio</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/text/stable/index.html">
                  <span class="dropdown-title">torchtext</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/vision/stable/index.html">
                  <span class="dropdown-title">torchvision</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torcharrow">
                  <span class="dropdown-title">torcharrow</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/data">
                  <span class="dropdown-title">TorchData</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torchrec">
                  <span class="dropdown-title">TorchRec</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/serve/">
                  <span class="dropdown-title">TorchServe</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torchx/">
                  <span class="dropdown-title">TorchX</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/xla">
                  <span class="dropdown-title">PyTorch on XLA Devices</span>
                  <p></p>
                </a>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-arrow">
                Resources
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/features">
                  <span class="dropdown-title">About</span>
                  <p>Learn about PyTorch’s features and capabilities</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/foundation">
                  <span class="dropdown-title">PyTorch Foundation</span>
                  <p>Learn about the PyTorch foundation</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/#community-module">
                  <span class="dropdown-title">Community</span>
                  <p>Join the PyTorch developer community to contribute, learn, and get your questions answered.</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/community-stories">
                  <span class="dropdown-title">Community Stories</span>
                  <p>Learn how our community solves real, everyday machine learning problems with PyTorch.</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/resources">
                  <span class="dropdown-title">Developer Resources</span>
                  <p>Find resources and get questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/events">
                  <span class="dropdown-title">Events</span>
                  <p>Find events, webinars, and podcasts</p>
                </a>
                <a class="nav-dropdown-item" href="https://discuss.pytorch.org/" target="_blank">
                  <span class="dropdown-title">Forums</span>
                  <p>A place to discuss PyTorch code, issues, install, research</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/hub">
                  <span class="dropdown-title">Models (Beta)</span>
                  <p>Discover, publish, and reuse pre-trained models</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <a href="https://github.com/pytorch/pytorch">GitHub</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

<body class="pytorch-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            

            
              
              
                <div class="version">
                  master 
                </div>
              
            

            


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

            
          </div>

          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">TorchServe</a></li>
<li class="toctree-l1"><a class="reference internal" href="Troubleshooting.html">Troubleshooting Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="performance_guide.html">Performance Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="batch_inference_with_ts.html">Batch Inference with TorchServe</a></li>
<li class="toctree-l1"><a class="reference internal" href="code_coverage.html">Code Coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Advanced configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="custom_service.html">Custom Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="default_handlers.html">TorchServe default inference handlers</a></li>
<li class="toctree-l1"><a class="reference internal" href="logging.html">Logging in Torchserve</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">TorchServe Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="model_zoo.html">Model Zoo</a></li>
<li class="toctree-l1"><a class="reference internal" href="request_envelopes.html">Request Envelopes</a></li>
<li class="toctree-l1"><a class="reference internal" href="server.html">Running TorchServe</a></li>
<li class="toctree-l1"><a class="reference internal" href="mps.html">Running TorchServe with NVIDIA MPS</a></li>
<li class="toctree-l1"><a class="reference internal" href="snapshot.html">TorchServe model snapshot</a></li>
<li class="toctree-l1"><a class="reference internal" href="torchserve_on_win_native.html">TorchServe on Windows</a></li>
<li class="toctree-l1"><a class="reference internal" href="torchserve_on_wsl.html">TorchServe on Windows Subsystem for Linux (WSL)</a></li>
<li class="toctree-l1"><a class="reference internal" href="use_cases.html">Torchserve Use Cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="workflows.html">TorchServe Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="large_model_inference.html">Serving large models with Torchserve</a></li>
<li class="toctree-l1"><a class="reference internal" href="FAQs.html">FAQ’S</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Service APIs:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="grpc_api.html">TorchServe gRPC API</a></li>
<li class="toctree-l1"><a class="reference internal" href="inference_api.html">Inference API</a></li>
<li class="toctree-l1"><a class="reference internal" href="management_api.html">Management API</a></li>
<li class="toctree-l1"><a class="reference internal" href="metrics_api.html">Metrics API</a></li>
<li class="toctree-l1"><a class="reference internal" href="rest_api.html">TorchServe REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="workflow_inference_api.html">Workflow Inference API</a></li>
<li class="toctree-l1"><a class="reference internal" href="workflow_management_api.html">Management API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer APIs:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api/ts.html">ts package</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/ts.torch_handler.request_envelope.html">ts.torch_handler.request_envelope package</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/ts.torch_handler.html">ts.torch_handler package</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/ts.metrics.html">ts.metrics package</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/ts.model_service.html">ts.model_service package</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/ts.protocol.html">ts.protocol package</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/modules.html">serve</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="contents.html">
          
            Docs
          
        </a> &gt;
      </li>

        
      <li>TorchServe Metrics</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
            
            <a href="_sources/metrics.md.txt" rel="nofollow"><img src="_static/images/view-page-source-icon.svg"></a>
          
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        
          <!-- Google Tag Manager (noscript) -->
          <noscript><iframe src="https://www.googletagmanager.com/ns.html?id="
          height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
          <!-- End Google Tag Manager (noscript) -->
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <section id="torchserve-metrics">
<h1><a class="reference external" href="#torchserve-metrics">TorchServe Metrics</a><a class="headerlink" href="#torchserve-metrics" title="Permalink to this heading">¶</a></h1>
<section id="contents-of-this-document">
<h2>Contents of this document<a class="headerlink" href="#contents-of-this-document" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="#introduction">Introduction</a></p></li>
<li><p><a class="reference external" href="#system-metrics">System metrics</a></p></li>
<li><p><a class="reference external" href="#formatting">Formatting</a></p></li>
<li><p><a class="reference external" href="#metric-types">Metric Types</a></p></li>
<li><p><a class="reference external" href="#central-metrics-yaml-file-definition">Central metrics yaml file definition</a></p></li>
<li><p><a class="reference external" href="#custom-metrics-api">Custom Metrics API</a></p></li>
<li><p><a class="reference external" href="#log-custom-metrics">Logging custom metrics</a></p></li>
<li><p><a class="reference external" href="#Metrics-YAML-File-Parsing-and-Metrics-API-Custom-Handler-Example">Metrics YAML Parsing and Metrics API example</a></p></li>
</ul>
</section>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">¶</a></h2>
<p>Torchserve metrics can be broadly classified into frontend and backend metrics.
Frontend metrics include system level metrics. The host resource utilization frontend metrics are collected at regular intervals(default: every minute).
Torchserve provides an API to collect custom backend metrics. Metrics defined by a custom service or handler code can be collected per request or per a batch of requests.
Two metric modes are supported, i.e <code class="docutils literal notranslate"><span class="pre">log</span></code> and <code class="docutils literal notranslate"><span class="pre">prometheus</span></code>. The default mode is <code class="docutils literal notranslate"><span class="pre">log</span></code>.
Metrics mode can be configured using the <code class="docutils literal notranslate"><span class="pre">metrics_mode</span></code> configuration option in <code class="docutils literal notranslate"><span class="pre">config.properties</span></code> or <code class="docutils literal notranslate"><span class="pre">TS_METRICS_MODE</span></code> environment variable.
For further details on <code class="docutils literal notranslate"><span class="pre">config.properties</span></code> and environment variable based configuration, refer <a class="reference internal" href="configuration.html"><span class="doc">Torchserve config</span></a> docs.</p>
<p>In <code class="docutils literal notranslate"><span class="pre">log</span></code> mode, Metrics are logged and can be aggregated by metric agents.
Metrics are collected by default at the following locations in <code class="docutils literal notranslate"><span class="pre">log</span></code> mode:</p>
<ul class="simple">
<li><p>Frontend metrics - <code class="docutils literal notranslate"><span class="pre">log_directory/ts_metrics.log</span></code></p></li>
<li><p>Backend metrics - <code class="docutils literal notranslate"><span class="pre">log</span> <span class="pre">directory/model_metrics.log</span></code></p></li>
</ul>
<p>The location of log files and metric files can be configured in the <a class="reference external" href="https://github.com/pytorch/serve/blob/master/frontend/server/src/main/resources/log4j2.xml">log4j2.xml</a> file</p>
<p>In <code class="docutils literal notranslate"><span class="pre">prometheus</span></code> mode, all metrics are made available in prometheus format via the <a class="reference external" href="https://github.com/pytorch/serve/blob/master/docs/metrics_api">metrics</a> API endpoint.</p>
</section>
<section id="frontend-metrics">
<h2>Frontend Metrics<a class="headerlink" href="#frontend-metrics" title="Permalink to this heading">¶</a></h2>
<table border="1" class="docutils">
<thead>
<tr>
<th>Metric Name</th>
<th>Type</th>
<th>Unit</th>
<th>Dimensions</th>
<th>Semantics</th>
</tr>
</thead>
<tbody>
<tr>
<td>Requests2XX</td>
<td>counter</td>
<td>Count</td>
<td>Level, Hostname</td>
<td>Total number of requests with response in 200-300 status code range</td>
</tr>
<tr>
<td>Requests4XX</td>
<td>counter</td>
<td>Count</td>
<td>Level, Hostname</td>
<td>Total number of requests with response in 400-500 status code range</td>
</tr>
<tr>
<td>Requests5XX</td>
<td>counter</td>
<td>Count</td>
<td>Level, Hostname</td>
<td>Total number of requests with response status code above 500</td>
</tr>
<tr>
<td>ts_inference_requests_total</td>
<td>counter</td>
<td>Count</td>
<td>model_name, model_version, hostname</td>
<td>Total number of inference requests received</td>
</tr>
<tr>
<td>ts_inference_latency_microseconds</td>
<td>counter</td>
<td>Microseconds</td>
<td>model_name, model_version, hostname</td>
<td>Total inference latency in Microseconds</td>
</tr>
<tr>
<td>ts_queue_latency_microseconds</td>
<td>counter</td>
<td>Microseconds</td>
<td>model_name, model_version, hostname</td>
<td>Total queue latency in Microseconds</td>
</tr>
<tr>
<td>QueueTime</td>
<td>gauge</td>
<td>Milliseconds</td>
<td>Level, Hostname</td>
<td>Time spent by a job in request queue in Milliseconds</td>
</tr>
<tr>
<td>WorkerThreadTime</td>
<td>gauge</td>
<td>Milliseconds</td>
<td>Level, Hostname</td>
<td>Time spent in worker thread excluding backend response time in Milliseconds</td>
</tr>
<tr>
<td>WorkerLoadTime</td>
<td>gauge</td>
<td>Milliseconds</td>
<td>WorkerName, Level, Hostname</td>
<td>Time taken by worker to load model in Milliseconds</td>
</tr>
<tr>
<td>CPUUtilization</td>
<td>gauge</td>
<td>Percent</td>
<td>Level, Hostname</td>
<td>CPU utilization on host</td>
</tr>
<tr>
<td>MemoryUsed</td>
<td>gauge</td>
<td>Megabytes</td>
<td>Level, Hostname</td>
<td>Memory used on host</td>
</tr>
<tr>
<td>MemoryAvailable</td>
<td>gauge</td>
<td>Megabytes</td>
<td>Level, Hostname</td>
<td>Memory available on host</td>
</tr>
<tr>
<td>MemoryUtilization</td>
<td>gauge</td>
<td>Percent</td>
<td>Level, Hostname</td>
<td>Memory utilization on host</td>
</tr>
<tr>
<td>DiskUsage</td>
<td>gauge</td>
<td>Gigabytes</td>
<td>Level, Hostname</td>
<td>Disk used on host</td>
</tr>
<tr>
<td>DiskUtilization</td>
<td>gauge</td>
<td>Percent</td>
<td>Level, Hostname</td>
<td>Disk used on host</td>
</tr>
<tr>
<td>DiskAvailable</td>
<td>gauge</td>
<td>Gigabytes</td>
<td>Level, Hostname</td>
<td>Disk available on host</td>
</tr>
<tr>
<td>GPUMemoryUtilization</td>
<td>gauge</td>
<td>Percent</td>
<td>Level, DeviceId, Hostname</td>
<td>GPU memory utilization on host, DeviceId</td>
</tr>
<tr>
<td>GPUMemoryUsed</td>
<td>gauge</td>
<td>Megabytes</td>
<td>Level, DeviceId, Hostname</td>
<td>GPU memory used on host, DeviceId</td>
</tr>
<tr>
<td>GPUUtilization</td>
<td>gauge</td>
<td>Percent</td>
<td>Level, DeviceId, Hostname</td>
<td>GPU utilization on host, DeviceId</td>
</tr>
</tbody>
</table></section>
<section id="backend-metrics">
<h2>Backend Metrics<a class="headerlink" href="#backend-metrics" title="Permalink to this heading">¶</a></h2>
<table border="1" class="docutils">
<thead>
<tr>
<th>Metric Name</th>
<th>Type</th>
<th>Unit</th>
<th>Dimensions</th>
<th>Semantics</th>
</tr>
</thead>
<tbody>
<tr>
<td>HandlerTime</td>
<td>gauge</td>
<td>ms</td>
<td>ModelName, Level, Hostname</td>
<td>Time spent in backend handler</td>
</tr>
<tr>
<td>PredictionTime</td>
<td>gauge</td>
<td>ms</td>
<td>ModelName, Level, Hostname</td>
<td>Backend prediction time</td>
</tr>
</tbody>
</table></section>
<section id="formatting">
<h2>Formatting<a class="headerlink" href="#formatting" title="Permalink to this heading">¶</a></h2>
<p>TorchServe emits metrics to log files by default. The metrics are formatted in a <a class="reference external" href="https://github.com/etsy/statsd">StatsD</a> like format.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>CPUUtilization.Percent:0.0<span class="p">|</span><span class="c1">#Level:Host|#hostname:my_machine_name,timestamp:1682098185</span>
DiskAvailable.Gigabytes:318.0416717529297<span class="p">|</span><span class="c1">#Level:Host|#hostname:my_machine_name,timestamp:1682098185</span>
</pre></div>
</div>
<p>To enable metric logging in JSON format, set “patternlayout” as “JSONPatternLayout” in <a class="reference external" href="https://github.com/pytorch/serve/blob/master/frontend/server/src/main/resources/log4j2.xml">log4j2.xml</a> (See sample <a class="reference external" href="https://github.com/pytorch/serve/blob/master/frontend/server/src/test/resources/log4j2-json.xml">log4j2-json.xml</a>). For information, see <a class="reference external" href="https://github.com/pytorch/serve/blob/master/docs/logging">Logging in Torchserve</a>.</p>
<p>After you enable JSON log formatting, logs will look as follows:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;MetricName&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;DiskAvailable&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;Value&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;108.15547180175781&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;Unit&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Gigabytes&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;Dimensions&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;Name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Level&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;Value&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Host&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;HostName&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;my_machine_name&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;MetricName&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;DiskUsage&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;Value&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;124.13163757324219&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;Unit&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Gigabytes&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;Dimensions&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;Name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Level&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;Value&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Host&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;HostName&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;my_machine_name&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>To enable metric logging in QLog format, set “patternlayout” as “QLogLayout” in <a class="reference external" href="https://github.com/pytorch/serve/blob/master/frontend/server/src/main/resources/log4j2.xml">log4j2.xml</a> (See sample <a class="reference external" href="https://github.com/pytorch/serve/blob/master/frontend/server/src/test/resources/log4j2-qlog.xml">log4j2-qlog.xml</a>). For information, see <a class="reference external" href="https://github.com/pytorch/serve/blob/master/docs/logging">Logging in Torchserve</a>.</p>
<p>After you enable QLogsetupModelDependencies formatting, logs will look as follows:</p>
<div class="highlight-qlog notranslate"><div class="highlight"><pre><span></span>HostName=abc.com
StartTime=1646686978
Program=MXNetModelServer
Metrics=MemoryUsed=5790.98046875 Megabytes Level|Host
EOE
HostName=147dda19895c.ant.amazon.com
StartTime=1646686978
Program=MXNetModelServer
Metrics=MemoryUtilization=46.2 Percent Level|Host
EOE
</pre></div>
</div>
</section>
<section id="metric-types">
<h2>Metric Types<a class="headerlink" href="#metric-types" title="Permalink to this heading">¶</a></h2>
<p>TorchServe Metrics is introducing <a class="reference external" href="https://github.com/pytorch/serve/blob/master/ts/metrics/metric_type_enum.py">Metric Types</a>
that are in line with the <a class="reference external" href="https://github.com/prometheus/client_python">Prometheus API</a> metric types.</p>
<p>Metric types are an attribute of Metric objects.
Users will be restricted to the existing metric types when adding metrics via Metrics API.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MetricTypes</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">COUNTER</span> <span class="o">=</span> <span class="s2">&quot;counter&quot;</span>
    <span class="n">GAUGE</span> <span class="o">=</span> <span class="s2">&quot;gauge&quot;</span>
    <span class="n">HISTOGRAM</span> <span class="o">=</span> <span class="s2">&quot;histogram&quot;</span>
</pre></div>
</div>
</section>
<section id="central-metrics-yaml-file-definition">
<h2>Central metrics YAML file definition<a class="headerlink" href="#central-metrics-yaml-file-definition" title="Permalink to this heading">¶</a></h2>
<p>TorchServe defines metrics in a <a class="reference external" href="https://github.com/pytorch/serve/blob/master/ts/configs/metrics.yaml">yaml</a>
file, including both frontend metrics (i.e. <code class="docutils literal notranslate"><span class="pre">ts_metrics</span></code>) and backend metrics (i.e. <code class="docutils literal notranslate"><span class="pre">model_metrics</span></code>).
When TorchServe is started, the metrics definition is loaded in the frontend and backend cache separately.
The backend flushes the metrics cache once a load model or inference request is completed.</p>
<p>Dynamic updates between the frontend and backend are <em>not</em> currently being handled.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">metrics.yaml</span></code> is formatted with Prometheus metric type terminology:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">dimensions</span><span class="p">:</span><span class="w"> </span><span class="c1"># dimension aliases</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nl">&amp;model_name</span><span class="w"> </span><span class="s">&quot;ModelName&quot;</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nl">&amp;level</span><span class="w"> </span><span class="s">&quot;Level&quot;</span>

<span class="nt">ts_metrics</span><span class="p">:</span><span class="w">  </span><span class="c1"># frontend metrics</span>
<span class="w">  </span><span class="nt">counter</span><span class="p">:</span><span class="w">  </span><span class="c1"># metric type</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NameOfCounterMetric</span><span class="w">  </span><span class="c1"># name of metric</span>
<span class="w">      </span><span class="nt">unit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ms</span><span class="w">  </span><span class="c1"># unit of metric</span>
<span class="w">      </span><span class="nt">dimensions</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">*model_name</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">*level</span><span class="p p-Indicator">]</span><span class="w">  </span><span class="c1"># dimension names of metric (referenced from the above dimensions dict)</span>
<span class="w">  </span><span class="nt">gauge</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NameOfGaugeMetric</span>
<span class="w">      </span><span class="nt">unit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ms</span>
<span class="w">      </span><span class="nt">dimensions</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">*model_name</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">*level</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">histogram</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NameOfHistogramMetric</span>
<span class="w">      </span><span class="nt">unit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ms</span>
<span class="w">      </span><span class="nt">dimensions</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">*model_name</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">*level</span><span class="p p-Indicator">]</span>

<span class="nt">model_metrics</span><span class="p">:</span><span class="w">  </span><span class="c1"># backend metrics</span>
<span class="w">  </span><span class="nt">counter</span><span class="p">:</span><span class="w">  </span><span class="c1"># metric type</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">InferenceTimeInMS</span><span class="w">  </span><span class="c1"># name of metric</span>
<span class="w">      </span><span class="nt">unit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ms</span><span class="w">  </span><span class="c1"># unit of metric</span>
<span class="w">      </span><span class="nt">dimensions</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">*model_name</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">*level</span><span class="p p-Indicator">]</span><span class="w">  </span><span class="c1"># dimension names of metric (referenced from the above dimensions dict)</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NumberOfMetrics</span>
<span class="w">      </span><span class="nt">unit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">count</span>
<span class="w">      </span><span class="nt">dimensions</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">*model_name</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">gauge</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">GaugeModelMetricNameExample</span>
<span class="w">      </span><span class="nt">unit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ms</span>
<span class="w">      </span><span class="nt">dimensions</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">*model_name</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">*level</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">histogram</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HistogramModelMetricNameExample</span>
<span class="w">      </span><span class="nt">unit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ms</span>
<span class="w">      </span><span class="nt">dimensions</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">*model_name</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">*level</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
<p>Default metrics are provided in the <a class="reference external" href="https://github.com/pytorch/serve/blob/master/ts/configs/metrics.yaml">metrics.yaml</a> file, but the user can either delete them to their liking / ignore them altogether, because these metrics will not be emitted unless they are edited.</p>
<section id="how-it-works">
<h3>How it works<a class="headerlink" href="#how-it-works" title="Permalink to this heading">¶</a></h3>
<p>Whenever torchserve starts, the <a class="reference external" href="https://github.com/pytorch/serve/blob/master/ts/model_service_worker.py">backend worker</a> initializes <code class="docutils literal notranslate"><span class="pre">service.context.metrics</span></code> with the <a class="reference external" href="https://github.com/pytorch/serve/blob/master/ts/metrics/metric_cache_yaml_impl.py">MetricsCache</a> object. The <code class="docutils literal notranslate"><span class="pre">model_metrics</span></code> (backend metrics) section within the specified yaml file will be parsed, and Metric objects will be created based on the parsed section and added  that are added to the cache.</p>
<p>This is all done internally, so the user does not have to do anything other than specifying the desired yaml file.</p>
<p><em>Users have the ability to parse other sections of the yaml file manually, but the primary purpose of this functionality is to
parse the backend metrics from the yaml file.</em></p>
</section>
<section id="user-manual-starting-torchserve-with-a-yaml-file-specified">
<h3>User Manual - starting TorchServe with a yaml file specified<a class="headerlink" href="#user-manual-starting-torchserve-with-a-yaml-file-specified" title="Permalink to this heading">¶</a></h3>
<ol>
<li><p>Create a <code class="docutils literal notranslate"><span class="pre">metrics.yaml</span></code> file to parse metrics from OR utilize default <a class="reference external" href="https://github.com/pytorch/serve/blob/master/ts/configs/metrics.yaml">metrics.yaml</a></p></li>
<li><p>Set <code class="docutils literal notranslate"><span class="pre">metrics_config</span></code> argument equal to the yaml file path in the <code class="docutils literal notranslate"><span class="pre">config.properties</span></code> being used:</p>
<div class="highlight-properties notranslate"><div class="highlight"><pre><span></span><span class="na">...</span>
<span class="na">...</span>
<span class="na">workflow_store</span><span class="o">=</span><span class="s">../archive/src/test/resources/workflows</span>
<span class="na">metrics_config</span><span class="o">=</span><span class="s">/&lt;path&gt;/&lt;to&gt;/&lt;metrics&gt;/&lt;file&gt;/metrics.yaml</span>
<span class="na">...</span>
<span class="na">...</span>
</pre></div>
</div>
<p>If a <code class="docutils literal notranslate"><span class="pre">metrics_config</span></code> argument is not specified, the default yaml file will be used.</p>
</li>
<li><p>Run torchserve and specify the path of the <code class="docutils literal notranslate"><span class="pre">config.properties</span></code> after the <code class="docutils literal notranslate"><span class="pre">ts-config</span></code> flag: (example using <a class="reference external" href="https://github.com/pytorch/serve/tree/master/examples/Huggingface_Transformers">Huggingface_Transformers</a>)</p>
<p><code class="docutils literal notranslate"><span class="pre">torchserve</span> <span class="pre">--start</span> <span class="pre">--model-store</span> <span class="pre">model_store</span> <span class="pre">--models</span> <span class="pre">my_tc=BERTSeqClassification.mar</span> <span class="pre">--ncs</span> <span class="pre">--ts-config</span> <span class="pre">/&lt;path&gt;/&lt;to&gt;/&lt;config&gt;/&lt;file&gt;/config.properties</span></code></p>
</li>
</ol>
</section>
</section>
<section id="custom-metrics-api">
<h2>Custom Metrics API<a class="headerlink" href="#custom-metrics-api" title="Permalink to this heading">¶</a></h2>
<p>TorchServe enables the custom service code to emit metrics that are then made available based on the configured <code class="docutils literal notranslate"><span class="pre">metrics_mode</span></code>.</p>
<p>The custom service code is provided with a <a class="reference external" href="https://github.com/pytorch/serve/blob/master/ts/context.py">context</a> of the current request with a metrics object:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Access context metrics as follows</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">metrics</span>
</pre></div>
</div>
<p>All metrics are collected within the context.</p>
<section id="specifying-metric-types">
<h3>Specifying Metric Types<a class="headerlink" href="#specifying-metric-types" title="Permalink to this heading">¶</a></h3>
<p>When adding any metric via Metrics API, users have the ability to override the metric type by specifying the positional argument
<code class="docutils literal notranslate"><span class="pre">metric_type=MetricTypes.[COUNTER/GAUGE/HISTOGRAM]</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">metric1</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">add_metric</span><span class="p">(</span><span class="s2">&quot;GenericMetric&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">,</span> <span class="n">dimension_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;name1&quot;</span><span class="p">,</span> <span class="s2">&quot;name2&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">metric_type</span><span class="o">=</span><span class="n">MetricTypes</span><span class="o">.</span><span class="n">GAUGE</span><span class="p">)</span>
<span class="n">metric</span><span class="o">.</span><span class="n">add_or_update</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">dimension_values</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;value1&quot;</span><span class="p">,</span> <span class="s2">&quot;value2&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span>

<span class="c1"># Backwards compatible, combines the above two method calls</span>
<span class="n">metrics</span><span class="o">.</span><span class="n">add_counter</span><span class="p">(</span><span class="s2">&quot;CounterMetric&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dimensions</span><span class="o">=</span><span class="p">[</span><span class="n">Dimension</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">),</span> <span class="o">...</span><span class="p">])</span>
</pre></div>
</div>
</section>
<section id="updating-metrics-parsed-from-the-yaml-file">
<h3>Updating Metrics parsed from the yaml file<a class="headerlink" href="#updating-metrics-parsed-from-the-yaml-file" title="Permalink to this heading">¶</a></h3>
<p>Given the Metrics API, users will also be able to update metrics that have been parsed from the <a class="reference external" href="https://github.com/pytorch/serve/blob/master/ts/configs/metrics.yaml">yaml</a> file
given some criteria:</p>
<p>(we will use the following metric as an example)</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="nt">counter</span><span class="p">:</span><span class="w">  </span><span class="c1"># metric type</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">InferenceTimeInMS</span><span class="w">  </span><span class="c1"># name of metric</span>
<span class="w">      </span><span class="nt">unit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ms</span><span class="w">  </span><span class="c1"># unit of metric</span>
<span class="w">      </span><span class="nt">dimensions</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">ModelName</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">Level</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
<ol class="simple">
<li><p>Metric Type has to be the same</p>
<ol class="simple">
<li><p>The user will have to use a counter-based <code class="docutils literal notranslate"><span class="pre">add_...</span></code> method,
or explicitly set <code class="docutils literal notranslate"><span class="pre">metric_type=MetricTypes.counter</span></code> within the <code class="docutils literal notranslate"><span class="pre">add_...</span></code> method</p></li>
</ol>
</li>
<li><p>Metric Name has to be the same</p>
<ol class="simple">
<li><p>If the name of the metric in the YAML file you want to update is <code class="docutils literal notranslate"><span class="pre">InferenceTimeInMS</span></code>, then <code class="docutils literal notranslate"><span class="pre">add_metric(name=&quot;InferenceTimeInMS&quot;,</span> <span class="pre">...)</span></code></p></li>
</ol>
</li>
<li><p>Dimensions should be the same (as well as the same order!)</p>
<ol class="simple">
<li><p>All dimensions have to match, and Metric objects that have been parsed from the yaml file also have dimension names that are parsed from the yaml file</p>
<ol class="simple">
<li><p>Users can <a class="reference external" href="#create-dimension-objects">create their own</a> <code class="docutils literal notranslate"><span class="pre">Dimension</span></code> objects to match those in the yaml file dimensions</p></li>
<li><p>if the Metric object has <code class="docutils literal notranslate"><span class="pre">ModelName</span></code> and <code class="docutils literal notranslate"><span class="pre">Level</span></code> dimensions only, it is optional to specify additional dimensions since these are considered <a class="reference external" href="#default-dimensions">default dimensions</a>, so: <code class="docutils literal notranslate"><span class="pre">add_counter('InferenceTimeInMS',</span> <span class="pre">value=2)</span></code> or <code class="docutils literal notranslate"><span class="pre">add_counter('InferenceTimeInMS',</span> <span class="pre">value=2,</span> <span class="pre">dimensions=[&quot;ModelName&quot;,</span> <span class="pre">&quot;Level&quot;])</span></code></p></li>
</ol>
</li>
</ol>
</li>
</ol>
</section>
<section id="default-dimensions">
<h3>Default dimensions<a class="headerlink" href="#default-dimensions" title="Permalink to this heading">¶</a></h3>
<p>Metrics will have a couple of default dimensions if not already specified.</p>
<p>If the metric is a type <code class="docutils literal notranslate"><span class="pre">Gauge</span></code>, <code class="docutils literal notranslate"><span class="pre">Histogram</span></code>, <code class="docutils literal notranslate"><span class="pre">Counter</span></code>, by default it will have:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ModelName,{name_of_model}</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Level,Model</span></code></p></li>
</ul>
</section>
<section id="create-dimension-object-s">
<h3>Create dimension object(s)<a class="headerlink" href="#create-dimension-object-s" title="Permalink to this heading">¶</a></h3>
<p>Dimensions for metrics can be defined as objects</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ts.metrics.dimension</span> <span class="kn">import</span> <span class="n">Dimension</span>

<span class="c1"># Dimensions are name value pairs</span>
<span class="n">dim1</span> <span class="o">=</span> <span class="n">Dimension</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
<span class="n">dim2</span> <span class="o">=</span> <span class="n">Dimension</span><span class="p">(</span><span class="n">some_name</span><span class="p">,</span> <span class="n">some_value</span><span class="p">)</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="n">dimN</span><span class="o">=</span> <span class="n">Dimension</span><span class="p">(</span><span class="n">name_n</span><span class="p">,</span> <span class="n">value_n</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>NOTE:</strong> Metric functions below accept a list of dimensions</p>
</section>
<section id="add-generic-metrics">
<h3>Add generic metrics<a class="headerlink" href="#add-generic-metrics" title="Permalink to this heading">¶</a></h3>
<p><strong>Generic metrics are defaulted to a <code class="docutils literal notranslate"><span class="pre">COUNTER</span></code> metric type</strong></p>
<p>One can add metrics with generic units using the following function.</p>
<p>Function API</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">add_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dimension_names</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="n">metric_type</span><span class="p">:</span> <span class="n">MetricTypes</span> <span class="o">=</span> <span class="n">MetricTypes</span><span class="o">.</span><span class="n">COUNTER</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new metric and add into cache.</span>
<span class="sd">            Add a metric which is generic with custom metrics</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        metric_name: str</span>
<span class="sd">            Name of metric</span>
<span class="sd">        value: int, float</span>
<span class="sd">            value of metric</span>
<span class="sd">        unit: str</span>
<span class="sd">            unit of metric</span>
<span class="sd">        idx: int</span>
<span class="sd">            request_id index in batch</span>
<span class="sd">        dimensions: list</span>
<span class="sd">            list of dimensions for the metric</span>
<span class="sd">        metric_type: MetricTypes</span>
<span class="sd">            Type of metric</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">add_or_update</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">value</span><span class="p">:</span> <span class="nb">int</span> <span class="ow">or</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">dimension_values</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="n">request_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update metric value, request id and dimensions</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        value : int, float</span>
<span class="sd">            metric to be updated</span>
<span class="sd">        dimension_values : list</span>
<span class="sd">            list of dimension values</span>
<span class="sd">        request_id : str</span>
<span class="sd">            request id to be associated with the metric</span>
<span class="sd">        &quot;&quot;&quot;</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add Distance as a metric</span>
<span class="c1"># dimensions = [dim1, dim2, dim3, ..., dimN]</span>
<span class="c1"># Assuming batch size is 1 for example</span>
<span class="n">metric</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">add_metric</span><span class="p">(</span><span class="s1">&#39;DistanceInKM&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;km&#39;</span><span class="p">,</span> <span class="n">dimension_names</span><span class="o">=</span><span class="p">[</span><span class="o">...</span><span class="p">])</span>
<span class="n">metric</span><span class="o">.</span><span class="n">add_or_update</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">dimension_values</span><span class="o">=</span><span class="p">[</span><span class="o">...</span><span class="p">])</span>
</pre></div>
</div>
</section>
<section id="add-time-based-metrics">
<h3>Add time-based metrics<a class="headerlink" href="#add-time-based-metrics" title="Permalink to this heading">¶</a></h3>
<p><strong>Time-based metrics are defaulted to a <code class="docutils literal notranslate"><span class="pre">GAUGE</span></code> metric type</strong></p>
<p>Add time-based by invoking the following method:</p>
<p>Function API</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">add_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span> <span class="ow">or</span> <span class="nb">float</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ms&#39;</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">metric_type</span><span class="p">:</span> <span class="n">MetricTypes</span> <span class="o">=</span> <span class="n">MetricTypes</span><span class="o">.</span><span class="n">GAUGE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a time based metric like latency, default unit is &#39;ms&#39;</span>
<span class="sd">            Default metric type is gauge</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        metric_name : str</span>
<span class="sd">            metric name</span>
<span class="sd">        value: int</span>
<span class="sd">            value of metric</span>
<span class="sd">        idx: int</span>
<span class="sd">            request_id index in batch</span>
<span class="sd">        unit: str</span>
<span class="sd">            unit of metric,  default here is ms, s is also accepted</span>
<span class="sd">        dimensions: list</span>
<span class="sd">            list of dimensions for the metric</span>
<span class="sd">        metric_type: MetricTypes</span>
<span class="sd">           type for defining different operations, defaulted to gauge metric type for Time metrics</span>
<span class="sd">        &quot;&quot;&quot;</span>
</pre></div>
</div>
<p>Note that the default unit in this case is ‘ms’</p>
<p><strong>Supported units</strong>: <code class="docutils literal notranslate"><span class="pre">['ms',</span> <span class="pre">'s']</span></code></p>
<p>To add custom time-based metrics:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add inference time</span>
<span class="c1"># dimensions = [dim1, dim2, dim3, ..., dimN]</span>
<span class="c1"># Assuming batch size  is 1 for example</span>
<span class="n">metrics</span><span class="o">.</span><span class="n">add_time</span><span class="p">(</span><span class="s1">&#39;InferenceTime&#39;</span><span class="p">,</span> <span class="n">end_time</span><span class="o">-</span><span class="n">start_time</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;ms&#39;</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="add-size-based-metrics">
<h3>Add size-based metrics<a class="headerlink" href="#add-size-based-metrics" title="Permalink to this heading">¶</a></h3>
<p><strong>Size-based metrics are defaulted to a <code class="docutils literal notranslate"><span class="pre">GAUGE</span></code> metric type</strong></p>
<p>Add size-based metrics by invoking the following method:</p>
<p>Function API</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">add_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span> <span class="ow">or</span> <span class="nb">float</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;MB&#39;</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">metric_type</span><span class="p">:</span> <span class="n">MetricTypes</span> <span class="o">=</span> <span class="n">MetricTypes</span><span class="o">.</span><span class="n">GAUGE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a size based metric</span>
<span class="sd">            Default metric type is gauge</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        metric_name : str</span>
<span class="sd">            metric name</span>
<span class="sd">        value: int, float</span>
<span class="sd">            value of metric</span>
<span class="sd">        idx: int</span>
<span class="sd">            request_id index in batch</span>
<span class="sd">        unit: str</span>
<span class="sd">            unit of metric, default here is &#39;MB&#39;, &#39;kB&#39;, &#39;GB&#39; also supported</span>
<span class="sd">        dimensions: list</span>
<span class="sd">            list of dimensions for the metric</span>
<span class="sd">        metric_type: MetricTypes</span>
<span class="sd">           type for defining different operations, defaulted to gauge metric type for Size metrics</span>
<span class="sd">        &quot;&quot;&quot;</span>
</pre></div>
</div>
<p>Note that the default unit in this case is milliseconds (ms).</p>
<p><strong>Supported units</strong>: <code class="docutils literal notranslate"><span class="pre">['MB',</span> <span class="pre">'kB',</span> <span class="pre">'GB',</span> <span class="pre">'B']</span></code></p>
<p>To add custom size based metrics</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add Image size as a metric</span>
<span class="c1"># dimensions = [dim1, dim2, dim3, ..., dimN]</span>
<span class="c1"># Assuming batch size 1</span>
<span class="n">metrics</span><span class="o">.</span><span class="n">add_size</span><span class="p">(</span><span class="s1">&#39;SizeOfImage&#39;</span><span class="p">,</span> <span class="n">img_size</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;MB&#39;</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="add-percentage-based-metrics">
<h3>Add Percentage based metrics<a class="headerlink" href="#add-percentage-based-metrics" title="Permalink to this heading">¶</a></h3>
<p><strong>Percentage-based metrics are defaulted to a <code class="docutils literal notranslate"><span class="pre">GAUGE</span></code> metric type</strong></p>
<p>Percentage based metrics can be added by invoking the following method:</p>
<p>Function API</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">add_percent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span> <span class="ow">or</span> <span class="nb">float</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">metric_type</span><span class="p">:</span> <span class="n">MetricTypes</span> <span class="o">=</span> <span class="n">MetricTypes</span><span class="o">.</span><span class="n">GAUGE</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a percentage based metric</span>
<span class="sd">            Default metric type is gauge</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        metric_name : str</span>
<span class="sd">            metric name</span>
<span class="sd">        value: int, float</span>
<span class="sd">            value of metric</span>
<span class="sd">        idx: int</span>
<span class="sd">            request_id index in batch</span>
<span class="sd">        dimensions: list</span>
<span class="sd">            list of dimensions for the metric</span>
<span class="sd">        metric_type: MetricTypes</span>
<span class="sd">           type for defining different operations, defaulted to gauge metric type for Percent metrics</span>
<span class="sd">        &quot;&quot;&quot;</span>
</pre></div>
</div>
<p>To add custom percentage-based metrics:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add MemoryUtilization as a metric</span>
<span class="c1"># dimensions = [dim1, dim2, dim3, ..., dimN]</span>
<span class="c1"># Assuming batch size 1</span>
<span class="n">metrics</span><span class="o">.</span><span class="n">add_percent</span><span class="p">(</span><span class="s1">&#39;MemoryUtilization&#39;</span><span class="p">,</span> <span class="n">utilization_percent</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="add-counter-based-metrics">
<h3>Add counter-based metrics<a class="headerlink" href="#add-counter-based-metrics" title="Permalink to this heading">¶</a></h3>
<p><strong>Counter-based metrics are defaulted to a <code class="docutils literal notranslate"><span class="pre">COUNTER</span></code> metric type</strong></p>
<p>Counter based metrics can be added by invoking the following method</p>
<p>Function API</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">add_counter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span> <span class="ow">or</span> <span class="nb">float</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">metric_type</span><span class="p">:</span> <span class="n">MetricTypes</span> <span class="o">=</span> <span class="n">MetricTypes</span><span class="o">.</span><span class="n">COUNTER</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a counter metric or increment an existing counter metric</span>
<span class="sd">            Default metric type is counter</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        metric_name : str</span>
<span class="sd">            metric name</span>
<span class="sd">        value: int or float</span>
<span class="sd">            value of metric</span>
<span class="sd">        idx: int</span>
<span class="sd">            request_id index in batch</span>
<span class="sd">        dimensions: list</span>
<span class="sd">            list of dimensions for the metric</span>
<span class="sd">        metric_type: MetricTypes</span>
<span class="sd">           type for defining different operations, defaulted to counter metric type for Counter metrics</span>
<span class="sd">        &quot;&quot;&quot;</span>
</pre></div>
</div>
</section>
<section id="getting-a-metric">
<h3>Getting a metric<a class="headerlink" href="#getting-a-metric" title="Permalink to this heading">¶</a></h3>
<p>Users can get a metric from the cache. The Metric object is returned, so the user can access the methods of the Metric: (i.e. <code class="docutils literal notranslate"><span class="pre">Metric.update(value)</span></code>, <code class="docutils literal notranslate"><span class="pre">Metric.__str__</span></code>)</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">get_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">metric_type</span><span class="p">:</span> <span class="n">MetricTypes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Metric</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a Metric from cache.</span>
<span class="sd">            Ask user for required requirements to form metric key to retrieve Metric.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        metric_type: MetricTypes</span>
<span class="sd">            Type of metric: use MetricTypes enum to specify</span>

<span class="sd">        metric_name: str</span>
<span class="sd">            Name of metric</span>

<span class="sd">        &quot;&quot;&quot;</span>
</pre></div>
</div>
<p>i.e.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Method 1: Getting metric of metric name string, MetricType COUNTER</span>
<span class="n">metrics</span><span class="o">.</span><span class="n">get_metric</span><span class="p">(</span><span class="s2">&quot;MetricName&quot;</span><span class="p">,</span> <span class="n">MetricTypes</span><span class="o">.</span><span class="n">COUNTER</span><span class="p">)</span>

<span class="c1"># Method 2: Getting metric of metric name string, MetricType GAUGE</span>
<span class="n">metrics</span><span class="o">.</span><span class="n">get_metric</span><span class="p">(</span><span class="s2">&quot;GaugeMetricName&quot;</span><span class="p">,</span> <span class="n">MetricTypes</span><span class="o">.</span><span class="n">GAUGE</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="logging-custom-metrics">
<h2>Logging custom metrics<a class="headerlink" href="#logging-custom-metrics" title="Permalink to this heading">¶</a></h2>
<p>Following sample code can be used to log the custom metrics created in the model’s custom handler:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># In Custom Handler</span>
<span class="kn">from</span> <span class="nn">ts.service</span> <span class="kn">import</span> <span class="n">emit_metrics</span>

<span class="k">class</span> <span class="nc">ExampleCustomHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">,</span> <span class="n">ABC</span><span class="p">):</span>
   <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>

<span class="n">context</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">add_counter</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>This custom metrics information is logged in the <code class="docutils literal notranslate"><span class="pre">model_metrics.log</span></code> file configured through <a class="reference external" href="https://github.com/pytorch/serve/blob/master/frontend/server/src/main/resources/log4j2.xml">log4j2.xml</a> file
or made available via the <a class="reference external" href="https://github.com/pytorch/serve/blob/master/docs/metrics_api">metrics</a> API endpoint based on the <code class="docutils literal notranslate"><span class="pre">metrics_mode</span></code> configuration.</p>
</section>
<section id="metrics-yaml-file-parsing-and-metrics-api-custom-handler-example">
<h2>Metrics YAML File Parsing and Metrics API Custom Handler Example<a class="headerlink" href="#metrics-yaml-file-parsing-and-metrics-api-custom-handler-example" title="Permalink to this heading">¶</a></h2>
<p>This example utilizes the feature of parsing metrics from a YAML file, adding and updating metrics and their values via Metrics API,
updating metrics that have been parsed from the YAML file via Metrics API, and finally emitting all metrics that have been updated.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ts.service</span> <span class="kn">import</span> <span class="n">emit_metrics</span>
<span class="kn">from</span> <span class="nn">ts.metrics.metric_type_enum</span> <span class="kn">import</span> <span class="n">MetricTypes</span>


<span class="k">class</span> <span class="nc">CustomHandlerExample</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">metrics</span>  <span class="c1"># initializing metrics to the context.metrics</span>

        <span class="c1"># Setting a sleep for examples&#39; sake</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">stop_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># Adds a metric that has a metric type of gauge</span>
        <span class="n">metrics</span><span class="o">.</span><span class="n">add_time</span><span class="p">(</span>
            <span class="s2">&quot;HandlerTime&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">((</span><span class="n">stop_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;ms&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Logs the value 2.5 and -1.3 to the frontend</span>
        <span class="n">metrics</span><span class="o">.</span><span class="n">add_counter</span><span class="p">(</span><span class="s2">&quot;HandlerSeparateCounter&quot;</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">)</span>
        <span class="n">metrics</span><span class="o">.</span><span class="n">add_counter</span><span class="p">(</span><span class="s2">&quot;HandlerSeparateCounter&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.3</span><span class="p">)</span>

        <span class="c1"># Adding a standard counter metric</span>
        <span class="n">metrics</span><span class="o">.</span><span class="n">add_counter</span><span class="p">(</span><span class="s2">&quot;HandlerCounter&quot;</span><span class="p">,</span> <span class="mf">21.3</span><span class="p">)</span>

        <span class="c1"># Assume that a metric that has a metric type of counter</span>
        <span class="c1"># and is named InferenceTimeInMS in the metrics.yaml file.</span>
        <span class="c1"># Instead of creating a new object with the same name and same parameters,</span>
        <span class="c1"># this line will update the metric that already exists from the YAML file.</span>
        <span class="n">metrics</span><span class="o">.</span><span class="n">add_counter</span><span class="p">(</span><span class="s2">&quot;InferenceTimeInMS&quot;</span><span class="p">,</span> <span class="mf">2.78</span><span class="p">)</span>

        <span class="c1"># Another method of updating values -</span>
        <span class="c1"># using the get_metric + Metric.update method</span>
        <span class="c1"># In this example, we are getting an already existing</span>
        <span class="c1"># Metric that had been parsed from the yaml file</span>
        <span class="n">histogram_example_metric</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">get_metric</span><span class="p">(</span>
            <span class="s2">&quot;HistogramModelMetricNameExample&quot;</span><span class="p">,</span>
            <span class="n">MetricTypes</span><span class="o">.</span><span class="n">histogram</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">histogram_example_metric</span><span class="o">.</span><span class="n">add_or_update</span><span class="p">(</span><span class="mf">4.6</span><span class="p">)</span>

        <span class="c1"># Same idea as the &#39;metrics.add_counter(&#39;InferenceTimeInMS&#39;, 2.78)&#39; line,</span>
        <span class="c1"># except this time with gauge metric type object</span>
        <span class="n">metrics</span><span class="o">.</span><span class="n">add_size</span><span class="p">(</span><span class="s2">&quot;GaugeModelMetricNameExample&quot;</span><span class="p">,</span> <span class="mf">42.5</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>


             </article>
             
            </div>
            <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="model_zoo.html" class="btn btn-neutral float-right" title="Model Zoo" accesskey="n" rel="next">Next <img src="_static/images/chevron-right-orange.svg" class="next-page"></a>
      
      
        <a href="logging.html" class="btn btn-neutral" title="Logging in Torchserve" accesskey="p" rel="prev"><img src="_static/images/chevron-right-orange.svg" class="previous-page"> Previous</a>
      
    </div>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, PyTorch Serve Contributors.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

          </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              <ul>
<li><a class="reference internal" href="#">TorchServe Metrics</a><ul>
<li><a class="reference internal" href="#contents-of-this-document">Contents of this document</a></li>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#frontend-metrics">Frontend Metrics</a></li>
<li><a class="reference internal" href="#backend-metrics">Backend Metrics</a></li>
<li><a class="reference internal" href="#formatting">Formatting</a></li>
<li><a class="reference internal" href="#metric-types">Metric Types</a></li>
<li><a class="reference internal" href="#central-metrics-yaml-file-definition">Central metrics YAML file definition</a><ul>
<li><a class="reference internal" href="#how-it-works">How it works</a></li>
<li><a class="reference internal" href="#user-manual-starting-torchserve-with-a-yaml-file-specified">User Manual - starting TorchServe with a yaml file specified</a></li>
</ul>
</li>
<li><a class="reference internal" href="#custom-metrics-api">Custom Metrics API</a><ul>
<li><a class="reference internal" href="#specifying-metric-types">Specifying Metric Types</a></li>
<li><a class="reference internal" href="#updating-metrics-parsed-from-the-yaml-file">Updating Metrics parsed from the yaml file</a></li>
<li><a class="reference internal" href="#default-dimensions">Default dimensions</a></li>
<li><a class="reference internal" href="#create-dimension-object-s">Create dimension object(s)</a></li>
<li><a class="reference internal" href="#add-generic-metrics">Add generic metrics</a></li>
<li><a class="reference internal" href="#add-time-based-metrics">Add time-based metrics</a></li>
<li><a class="reference internal" href="#add-size-based-metrics">Add size-based metrics</a></li>
<li><a class="reference internal" href="#add-percentage-based-metrics">Add Percentage based metrics</a></li>
<li><a class="reference internal" href="#add-counter-based-metrics">Add counter-based metrics</a></li>
<li><a class="reference internal" href="#getting-a-metric">Getting a metric</a></li>
</ul>
</li>
<li><a class="reference internal" href="#logging-custom-metrics">Logging custom metrics</a></li>
<li><a class="reference internal" href="#metrics-yaml-file-parsing-and-metrics-api-custom-handler-example">Metrics YAML File Parsing and Metrics API Custom Handler Example</a></li>
</ul>
</li>
</ul>

            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
         <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
         <script src="_static/jquery.js"></script>
         <script src="_static/underscore.js"></script>
         <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
         <script src="_static/doctools.js"></script>
         <script src="_static/katex.min.js"></script>
         <script src="_static/auto-render.min.js"></script>
         <script src="_static/katex_autorenderer.js"></script>
     

  

  <script type="text/javascript" src="_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

  <!-- Begin Footer -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
    <div class="container">
      <div class="row">
        <div class="col-md-4 text-center">
          <h2>Docs</h2>
          <p>Access comprehensive developer documentation for PyTorch</p>
          <a class="with-right-arrow" href="https://pytorch.org/docs/stable/index.html">View Docs</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Tutorials</h2>
          <p>Get in-depth tutorials for beginners and advanced developers</p>
          <a class="with-right-arrow" href="https://pytorch.org/tutorials">View Tutorials</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Resources</h2>
          <p>Find development resources and get your questions answered</p>
          <a class="with-right-arrow" href="https://pytorch.org/resources">View Resources</a>
        </div>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://pytorch.org/" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/">PyTorch</a></li>
            <li><a href="https://pytorch.org/get-started">Get Started</a></li>
            <li><a href="https://pytorch.org/features">Features</a></li>
            <li><a href="https://pytorch.org/ecosystem">Ecosystem</a></li>
            <li><a href="https://pytorch.org/blog/">Blog</a></li>
            <li><a href="https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md">Contributing</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/resources">Resources</a></li>
            <li><a href="https://pytorch.org/tutorials">Tutorials</a></li>
            <li><a href="https://pytorch.org/docs/stable/index.html">Docs</a></li>
            <li><a href="https://discuss.pytorch.org" target="_blank">Discuss</a></li>
            <li><a href="https://github.com/pytorch/pytorch/issues" target="_blank">Github Issues</a></li>
            <li><a href="https://pytorch.org/assets/brand-guidelines/PyTorch-Brand-Guidelines.pdf" target="_blank">Brand Guidelines</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">Stay up to date</li>
            <li><a href="https://www.facebook.com/pytorch" target="_blank">Facebook</a></li>
            <li><a href="https://twitter.com/pytorch" target="_blank">Twitter</a></li>
            <li><a href="https://www.youtube.com/pytorch" target="_blank">YouTube</a></li>
            <li><a href="https://www.linkedin.com/company/pytorch" target="_blank">LinkedIn</a></li>
          </ul>  
          </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">PyTorch Podcasts</li>
            <li><a href="https://open.spotify.com/show/6UzHKeiy368jKfQMKKvJY5" target="_blank">Spotify</a></li>
            <li><a href="https://podcasts.apple.com/us/podcast/pytorch-developer-podcast/id1566080008" target="_blank">Apple</a></li>
            <li><a href="https://www.google.com/podcasts?feed=aHR0cHM6Ly9mZWVkcy5zaW1wbGVjYXN0LmNvbS9PQjVGa0lsOA%3D%3D" target="_blank">Google</a></li>
            <li><a href="https://music.amazon.com/podcasts/7a4e6f0e-26c2-49e9-a478-41bd244197d0/PyTorch-Developer-Podcast?" target="_blank">Amazon</a></li>
          </ul>
         </div>
        </div>
        
        <div class="privacy-policy">
          <ul>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/terms/" target="_blank">Terms</a></li>
            <li class="privacy-policy-links">|</li>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/privacy-policy/" target="_blank">Privacy</a></li>
          </ul>
        </div>
        <div class="copyright">
        <p>© Copyright The Linux Foundation. The PyTorch Foundation is a project of The Linux Foundation.
          For web site terms of use, trademark policy and other policies applicable to The PyTorch Foundation please see
          <a href="www.linuxfoundation.org/policies/">www.linuxfoundation.org/policies/</a>. The PyTorch Foundation supports the PyTorch open source
          project, which has been established as PyTorch Project a Series of LF Projects, LLC. For policies applicable to the PyTorch Project a Series of LF Projects, LLC,
          please see <a href="www.lfprojects.org/policies/">www.lfprojects.org/policies/</a>.</p>
      </div>
     </div>

  </footer>

  <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebook’s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="_static/images/pytorch-x.svg">
  </div>
</div>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>
            
          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="resources-mobile-menu-title">
            Docs
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/docs/stable/index.html">PyTorch</a>
            </li>

            <li>
              <a href="https://pytorch.org/audio/stable/index.html">torchaudio</a>
            </li>

            <li>
              <a href="https://pytorch.org/text/stable/index.html">torchtext</a>
            </li>

            <li>
              <a href="https://pytorch.org/vision/stable/index.html">torchvision</a>
            </li>

            <li>
              <a href="https://pytorch.org/torcharrow">torcharrow</a>
            </li>

            <li>
              <a href="https://pytorch.org/data">TorchData</a>
            </li>

            <li>
              <a href="https://pytorch.org/torchrec">TorchRec</a>
            </li>

            <li>
              <a href="https://pytorch.org/serve/">TorchServe</a>
            </li>

            <li>
              <a href="https://pytorch.org/torchx/">TorchX</a>
            </li>

            <li>
              <a href="https://pytorch.org/xla">PyTorch on XLA Devices</a>
            </li>
          </ul>

          <li class="resources-mobile-menu-title">
            Resources
          </li>
            
           <ul class="resources-mobile-menu-items">

            <li>
              <a href="https://pytorch.org/features">About</a>
            </li>

            <li>
              <a href="https://pytorch.org/foundation">PyTorch Foundation</a>
            </li>

            <li>
              <a href="https://pytorch.org/#community-module">Community</a>
            </li>

            <li>
              <a href="https://pytorch.org/community-stories">Community Stories</a>
            </li>

            <li>
              <a href="https://pytorch.org/resources">Developer Resources</a>
            </li>

            <li>
              <a href="https://pytorch.org/events">Events</a>
            </li>

            <li>
              <a href="https://discuss.pytorch.org/">Forums</a>
            </li>

            <li>
              <a href="https://pytorch.org/hub">Models (Beta)</a>
            </li>
          </ul>

          <li>
            <a href="https://github.com/pytorch/pytorch">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>